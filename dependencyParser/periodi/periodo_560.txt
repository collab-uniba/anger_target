Ugly stuff  but it'll do  for the moment.     